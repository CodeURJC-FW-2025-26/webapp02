{{> partials/header}}

<main class="recipe-container">
    <section class="row">
        <!-- Left Column: Image and Buttons -->
        <div class="col-md-5">
            <img src="/uploads/{{recipe.image}}" class="img-fluid rounded mb-3 recipe-image" alt="{{recipe.name}}">
            <div class="d-grid gap-2 d-md-flex justify-content-md-start mb-3">
                <!-- Edit Link (No changes needed here yet) -->
                <a href="/receta/editar/{{recipe._id}}" class="btn btn-success">Editar Receta</a>

                <!-- MODIFIED: Delete Recipe Form -->
                <!-- Added ID 'deleteRecipeForm' to target it with JS -->
                <!-- Added ID 'btnDeleteRecipe' to the button -->
                <form id="deleteRecipeForm" action="/receta/borrar/{{recipe._id}}" method="POST">
                    <button type="submit" class="btn btn-danger" id="btnDeleteRecipe">Borrar</button>
                </form>

                <a href="/" class="btn btn-info">Volver a página principal</a>
            </div>
        </div>

        <!-- Right Column: Recipe Details -->
        <div class="col-md-7">
            <h2 class="dish-title">{{recipe.name}}</h2>
            <div class="mb-3">
                <span class="badge bg-success">{{recipe.category}}</span>
                <span class="badge bg-info">Dificultad: {{recipe.difficulty}}</span>
                <span class="badge bg-secondary">Tiempo: {{recipe.preparation_time}} minutos</span>
            </div>
            <p class="lead">{{recipe.description}}</p>

            <h3 class="dish-subtitle mt-4">Ingredientes</h3>
            <div class="list-group list-group-flush" style="white-space: pre-wrap;">{{recipe.ingredients}}</div>
        </div>
    </section>

    <!-- Row 2: Preparation Steps -->
    <section class="row mt-5">
        <div class="col-12">
            <h3 class="dish-subtitle">Pasos de Preparación</h3>

            <!-- MODIFIED: Added ID 'stepsList' for dynamic DOM manipulation (AJAX Add/Delete) -->
            <ol id="stepsList" class="list-group list-group-numbered">
                {{#recipe.steps}}
                <!-- MODIFIED: Added dynamic ID 'step-{{_id}}' to remove this specific element from DOM on delete -->
                <li class="list-group-item d-flex justify-content-between align-items-center" id="step-{{_id}}">
                    <div class="ms-2 me-auto">
                        <!-- Wrappers for text (useful for Phase 5 Inline Editing) -->
                        <div class="fw-bold step-name">{{name}}</div>
                        <span class="step-desc">{{description}}</span>
                    </div>
                    <div class="d-flex gap-2">
                        <!-- Edit Button (Classic navigation for now, prepped for Phase 5) -->
                        <a href="/receta/{{recipe_id}}/paso/editar/{{_id}}"
                            class="btn btn-sm btn-outline-primary btn-edit-step" aria-label="Edit Step"
                            data-step-id="{{_id}}"><i class="bi bi-pencil"></i></a>

                        <!-- MODIFIED: Delete Step Form -->
                        <!-- Added class 'delete-step-form' for Event Delegation in client.js -->
                        <form class="delete-step-form" action="/receta/{{recipe_id}}/paso/borrar/{{_id}}" method="POST"
                            class="d-inline">
                            <button type="submit" class="btn btn-sm btn-outline-danger" aria-label="Delete Step"><i
                                    class="bi bi-trash"></i></button>
                        </form>
                    </div>
                </li>
                {{/recipe.steps}}
            </ol>

            {{^recipe.steps}}
            <!-- Optional: You might want to wrap this in a div with an ID to hide it when a step is added -->
            <p class="mt-3" id="noStepsMessage">Esta receta aún no tiene pasos definidos.</p>
            {{/recipe.steps}}
        </div>
    </section>

    <!-- Row 3: Form to add a new step -->
    <section class="row mt-5">
        <div class="col-12">
            <div class="add-step-form">
                <h3 class="dish-subtitle">Añadir Nuevo Paso</h3>

                <!-- MODIFIED: Add Step Form Configuration -->
                <!-- 1. Added ID 'addStepForm' -->
                <!-- 2. Added 'needs-validation' class for Bootstrap styles -->
                <!-- 3. Added 'novalidate' to disable browser default validation -->
                <form id="addStepForm" action="/receta/{{recipe._id}}/paso/nuevo" method="POST" class="needs-validation"
                    novalidate>

                    <div class="form-group mb-3">
                        <label for="stepName" class="form-label">Título del Paso:</label>
                        <!-- Added validation required -->
                        <input type="text" class="form-control" id="stepName" name="stepName"
                            placeholder="Ej: Preparar el sofrito" required>
                        <!-- Added Bootstrap Invalid Feedback Div -->
                        <div class="invalid-feedback">El título del paso es obligatorio.</div>
                    </div>

                    <div class="form-group mb-3">
                        <label for="stepDescription" class="form-label">Descripción del Paso:</label>
                        <!-- Added validation required -->
                        <textarea class="form-control" id="stepDescription" name="stepDescription" rows="3"
                            placeholder="Describe brevemente el paso" required></textarea>
                        <!-- Added Bootstrap Invalid Feedback Div -->
                        <div class="invalid-feedback">La descripción del paso es obligatoria.</div>
                    </div>

                    <button type="submit" class="btn btn-dark">Añadir Paso</button>
                </form>
            </div>
        </div>
    </section>

</main>

<!-- NEW: GENERIC CONFIRMATION MODAL -->
<!-- Used for Delete actions (Recipe and Steps) -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Acción</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                ¿Estás seguro?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmModalBtn">Confirmar</button>
            </div>
        </div>
    </div>
</div>

{{> partials/footer}}