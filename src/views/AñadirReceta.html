<!-- webapp02/src/views/AñadirReceta.html -->

{{> partials/header}}

<main class="container">

     <!-- Page Title: Dynamic based on editing state -->
     <h2 class="AddRecipe mt-4 mb-4">
          {{#editing}}Editar Receta{{/editing}}
          {{^editing}}Crear Nueva Receta{{/editing}}
     </h2>

     <div class="form-container">

          <!-- Server-Side Error Alerts -->
          {{#errorMessage}}
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
               <i class="bi bi-exclamation-triangle-fill me-2"></i> {{errorMessage}}
               <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          {{/errorMessage}}

          <!-- 
            Main Form 
            - 'needs-validation' enables Bootstrap styling.
            - 'novalidate' disables browser default bubbles to use custom logic.
            - 'enctype' required for file upload.
        -->
          <form id="recipeForm" class="needs-validation" novalidate
               action="{{#editing}}/receta/editar/{{recipe._id}}{{/editing}}{{^editing}}/receta/nueva{{/editing}}"
               method="POST" enctype="multipart/form-data">

               <!-- Field: Recipe Name -->
               <div class="form-group mb-3">
                    <label for="recipeName" class="form-label fw-bold">Nombre</label>
                    <input type="text" class="form-control" id="recipeName" name="recipeName"
                         placeholder="Ej: Paella Valenciana" value="{{recipe.name}}" required>
                    <div class="invalid-feedback">
                         El nombre es obligatorio y debe comenzar con mayúscula.
                    </div>
               </div>

               <!-- Field: Description -->
               <div class="form-group mb-3">
                    <label for="description" class="form-label fw-bold">Descripción</label>
                    <textarea class="form-control" id="description" name="description" rows="3"
                         placeholder="Describe brevemente el plato (20-500 caracteres)" minlength="20" maxlength="500"
                         required>{{recipe.description}}</textarea>
                    <div class="invalid-feedback">
                         La descripción debe tener entre 20 y 500 caracteres.
                    </div>
               </div>

               <!-- Field: Ingredients -->
               <div class="form-group mb-3">
                    <label for="ingredients" class="form-label fw-bold">Ingredientes</label>
                    <textarea class="form-control" id="ingredients" name="ingredients" rows="4"
                         placeholder="Lista los ingredientes (uno por línea o separados por comas)"
                         required>{{recipe.ingredients}}</textarea>
                    <div class="invalid-feedback">
                         La lista de ingredientes es obligatoria.
                    </div>
               </div>

               <!-- Field: Category (Select) -->
               <div class="form-group mb-3">
                    <label for="category" class="form-label fw-bold">Categoría</label>
                    <select class="form-select" id="category" name="category" required>
                         <option value="" disabled {{^recipe.category}}selected{{/recipe.category}}>Selecciona una
                              opción</option>
                         <option value="entrante" {{#recipe.isCategoryEntrante}}selected{{/recipe.isCategoryEntrante}}>
                              Entrante</option>
                         <option value="principal"
                              {{#recipe.isCategoryPrincipal}}selected{{/recipe.isCategoryPrincipal}}>Plato Principal
                         </option>
                         <option value="postre" {{#recipe.isCategoryPostre}}selected{{/recipe.isCategoryPostre}}>Postre
                         </option>
                         <option value="vegano" {{#recipe.isCategoryVegano}}selected{{/recipe.isCategoryVegano}}>Vegano
                         </option>
                    </select>
                    <div class="invalid-feedback">
                         Debes seleccionar una categoría.
                    </div>
               </div>

               <!-- Field: Difficulty (Select) -->
               <div class="form-group mb-3">
                    <label for="difficulty" class="form-label fw-bold">Dificultad</label>
                    <select class="form-select" id="difficulty" name="difficulty" required>
                         <option value="" disabled {{^recipe.difficulty}}selected{{/recipe.difficulty}}>Selecciona una
                              opción</option>
                         <option value="facil" {{#recipe.isDifficultyFacil}}selected{{/recipe.isDifficultyFacil}}>Fácil
                         </option>
                         <option value="media" {{#recipe.isDifficultyMedia}}selected{{/recipe.isDifficultyMedia}}>Media
                         </option>
                         <option value="dificil" {{#recipe.isDifficultyDificil}}selected{{/recipe.isDifficultyDificil}}>
                              Difícil</option>
                    </select>
                    <div class="invalid-feedback">
                         Indica el nivel de dificultad.
                    </div>
               </div>

               <!-- Field: Preparation Time -->
               <div class="form-group mb-3">
                    <label for="preparationTime" class="form-label fw-bold">Tiempo (minutos)</label>
                    <input type="number" class="form-control" id="preparationTime" name="preparationTime"
                         placeholder="Ej: 45" min="1" value="{{recipe.preparation_time}}" required>
                    <div class="invalid-feedback">
                         Introduce un tiempo válido (número positivo).
                    </div>
               </div>

               <!-- Field: Image Upload with Drag & Drop -->
               <div class="form-group mb-3">

                     <label for="recipeImage" class="form-label">Imagen</label>

                     <input type="file" class="form-control" id="recipeImage" name="recipeImage"></div>

                    <!-- Image Preview Container -->
                    <div id="image-preview-container" class="mt-3 {{^recipe.image}}d-none{{/recipe.image}} text-center">
                         {{#editing}}
                         {{#recipe.image}}
                         <div class="position-relative d-inline-block">
                              <img src="/uploads/{{recipe.image}}" class="img-thumbnail shadow-sm"
                                   style="max-height: 200px;" id="currentImage" alt="Previsualización">
                              <div class="mt-2">
                                   <button type="button" class="btn btn-sm btn-outline-danger" id="btnRemoveImage">
                                        <i class="bi bi-trash"></i> Eliminar imagen
                                   </button>
                              </div>
                         </div>
                         {{/recipe.image}}
                         {{/editing}}
                    </div>

                    <!-- Hidden flag for image deletion logic in backend -->
                    <input type="hidden" name="removeImageFlag" id="removeImageFlag" value="false">
               </div>

               <!-- Form Action Buttons -->
               <div class="buttons mt-5 d-flex gap-3">
                    <button type="submit" class="btn btn-dark btn-lg px-4">
                         Guardar Cambios
                    </button>
                    <a class="btn btn-dark btn-lg px-4 shadow-sm"
                         href="{{#editing}}/receta/{{recipe._id}}{{/editing}}{{^editing}}/{{/editing}}">
                         Cancelar
                    </a>
               </div>

          </form>

          <!-- Sidebar: Decorative Images (Hidden on mobile via CSS usually, but kept structure) -->
          <aside class="DecorativeImages d-none d-xl-flex">
               <img src="/images/tabla.jpg" alt="Plato decorativo 1" class="img-fluid rounded shadow-lg mb-3">
               <img src="/images/entrecot.jpg" alt="Plato decorativo 2" class="img-fluid rounded shadow-lg">
          </aside>

     </div>
</main>

{{> partials/footer}}